name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.HOST }}" >> ~/.ssh/known_hosts
        shell: bash

      - name: Deploy to server
        env:
          HOST: ${{ secrets.HOST }}
          USER: ${{ secrets.USERNAME }}
          APP_DIR: /home/${{ secrets.USERNAME }}/server_qurish
          PORT: ${{ secrets.PORT }}
        run: |
          set -e
          echo "ğŸš€ Starting deploy process..."

          ssh $USER@$HOST "
            set -e
            echo 'ğŸ§© Checking repository...'

            # Agar .git yo'q boâ€˜lsa, yangidan clone qilinadi
            if [ ! -d '$APP_DIR/.git' ]; then
              echo 'ğŸ“¦ Cloning repository...'
              rm -rf '$APP_DIR'
              git clone -b main https://github.com/shokhDeveloper/11.git '$APP_DIR'
            else
              echo 'ğŸ”„ Updating existing repository...'
              cd '$APP_DIR'
              git fetch origin main
              git reset --hard origin/main
            fi

            cd '$APP_DIR'

            if [ ! -f 'package.json' ]; then
              echo 'âŒ Error: package.json topilmadi. Clone notoâ€˜gâ€˜ri boâ€˜lgan.'
              exit 1
            fi

            echo 'âš™ï¸ Creating .env file...'
            echo 'PORT=$PORT' > .env

            echo 'ğŸ“¦ Installing dependencies...'
            npm install --legacy-peer-deps

            echo 'ğŸ—ï¸ Building project...'
            npm run build

            echo 'ğŸš€ Starting or restarting PM2 app...'
            if pm2 list | grep -q 'ci_cd_app'; then
              pm2 restart ci_cd_app
            else
              pm2 start dist/main.js --name ci_cd_app
            fi

            pm2 save
            echo 'âœ… Deployment completed successfully!'
          "
        shell: bash
# name: Deploy to VPS
# on:
#   push:
#     branches:
#       - main
# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       - name: Setup SSH key
#         run: |
#           mkdir -p ~/.ssh
#           echo "${{secrets.SSH_PRIVATE_KEY}}" > ~/.ssh/id_rsa
#           chmod 600 ~/.ssh/id_rsa
#         shell: bash

#       - name: Deploy to server
#         env:
#           HOST: ${{secrets.HOST}}
#           USER: ${{secrets.USERNAME}}
#           APP_DIR: /server_qurish
#           PORT: ${{secrets.PORT}}
#         run: |
#           ssh-keyscan -H $HOST >> ~/.ssh/known_hosts
#           ssh $USER@$HOST "
#             if [ ! -d $APP_DIR ]; then
#               mkdir -p $APP_DIR
#               git clone https://github.com/shokhDeveloper/11.git $APP_DIR
#             else
#               cd $APP_DIR
#               git pull origin main
#             fi

#             cd $APP_DIR
#             echo 'PORT=${PORT}' > .env
#             npm install
#             npm run build

#             if pm2 list | grep -q 'ci_cd_app'; then
#               pm2 restart ci_cd_app
#             else
#               pm2 start dist/main.js --name ci_cd_app
#             fi

#             pm2 save
#           "
#         shell: bash